<!DOCTYPE html>
<html>
<head>
    <title>Fueling Stations Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        /* Make the map container fill available screen space */
        #map {
            height: 85vh;  /* Set the height to 85% of the viewport height */
            width: 100%;  /* Make the map width 100% of the screen */
        }

        /* Style for the "Get My Location" button */
        #locationBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            z-index: 9999; /* Ensure the button is on top of other elements */
            width: 150px;  /* Set width for better accessibility */
        }

        /* Style for the custom options in the popup */
        .popup-options {
            margin-top: 10px;
        }

        .popup-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            width: 100%;
        }

        .popup-button:hover {
            background-color: #45a049;
        }

        /* Style for live location pin */
        .live-location-icon {
            width: 40px;  /* Increase size for better visibility */
            height: 40px;
            background-color: #ff5722;  /* A visible color */
            border-radius: 50%;
            border: 2px solid white;
        }

        /* Ensure popups and buttons remain readable */
        .leaflet-popup-content {
            font-size: 14px;
        }

        /* Adjust map buttons for visibility on mobile */
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out {
            z-index: 100; /* Ensure zoom buttons are above other elements */
        }
    </style>
</head>
<body>
    <button id="locationBtn">Get My Location</button>
    <div id="map"></div>
    <script>
        // Create the map with Toronto as default location if no location service
        var map = L.map('map').setView([43.651070, -79.347015], 10); // Default to Toronto, ON if location is not available
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fuel station data (latitude, longitude, address)
        var stations = [
            [43.7449999, -79.6912853, "BVD Brampton, 130 Delta Park, Brampton, ON"],
            [43.6590715, -79.6561726, "BVD Mississauga, 6125 Ordan Dr, Mississauga, ON"],
            [42.9934741, -82.3104226, "BVD Sarnia, 81 Ube Dr, Sarnia, ON"],
            [35.2990989, -84.7748544, "Charleston (Tennessee), 200 Lower River Road NW, Charleston, TN, 37310"],
            [30.517509, -81.636027, "Jacksonville (Florida) - Loves #603, 400 Pecan Park Road, Jacksonville, FL, 32218"],
            [30.4649705, -81.6732823, "Jacksonville (Florida) - Loves #828, 12921 Duval Rd, Jacksonville, FL 32218"]
            // Add more stations here
        ];

        // Add markers for fuel stations with fixed size (no zoom scaling)
        stations.forEach(function(station) {
            var marker = L.marker([station[0], station[1]], {
                icon: L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', // Default Leaflet pin
                    iconSize: [50, 50], // Fixed size for all zoom levels (larger than default)
                    iconAnchor: [25, 50], // Anchor at the bottom of the pin
                    popupAnchor: [0, -50]
                })
            }).addTo(map)
                .bindPopup(`
                    <b>${station[2]}</b>
                    <div class="popup-options">
                        <button class="popup-button" onclick="copyAddress('${station[2]}')">Copy Address</button>
                        <button class="popup-button" onclick="openGoogleMaps('${station[2]}')">Open in Google Maps</button>
                    </div>
                `);
        });

        // Function to copy the address to clipboard
        function copyAddress(address) {
            var textArea = document.createElement("textarea");
            textArea.value = address;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("Address copied to clipboard!");
        }

        // Function to open the address in Google Maps
        function openGoogleMaps(address) {
            var mapsUrl = `https://www.google.com/maps?q=${encodeURIComponent(address)}`;
            window.open(mapsUrl, '_blank');
        }

        // Variable for live location marker
        var liveMarker;

        // Function to get and show the driver's location when button is clicked
        document.getElementById('locationBtn').onclick = function() {
            alert("Button clicked. Requesting location...");

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    alert("Location found!");

                    var driverLat = position.coords.latitude;
                    var driverLon = position.coords.longitude;

                    // Create a custom icon for the live location (Google-style pin)
                    var liveIcon = L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', // Default pin
                        iconSize: [50, 50], // Increased size for better visibility
                        iconAnchor: [25, 50], // Adjust to anchor at the bottom of the pin
                        popupAnchor: [0, -50]
                    });

                    // If a live marker exists, update it, otherwise create it
                    if (liveMarker) {
                        liveMarker.setLatLng([driverLat, driverLon]); // Update position
                    } else {
                        liveMarker = L.marker([driverLat, driverLon], {icon: liveIcon}).addTo(map)
                            .bindPopup("You're here!").openPopup();
                    }

                    // Zoom the map to the driver's location
                    map.setView([driverLat, driverLon], 14); // Adjust zoom level if necessary

                    // Watch position to update location continuously
                    navigator.geolocation.watchPosition(function(position) {
                        var newLat = position.coords.latitude;
                        var newLon = position.coords.longitude;
                        liveMarker.setLatLng([newLat, newLon]); // Update the marker position
                        map.setView([newLat, newLon], 14); // Adjust map center
                    }, function(error) {
                        alert("Location update failed: " + error.message);
                    });
                }, function(error) {
                    alert("Geolocation failed: " + error.message);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        };

        // Automatically get location when the page loads (only once)
        window.onload = function() {
            alert("Attempting to get location automatically...");

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    alert("Automatic location detected!");

                    var driverLat = position.coords.latitude;
                    var driverLon = position.coords.longitude;

                    // Create a custom icon for the live location (Google-style pin)
                    var liveIcon = L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', // Default pin image
                        iconSize: [50, 50], // Larger size for better visibility
                        iconAnchor: [25, 50],
                        popupAnchor: [0, -50]
                    });

                    // Create or update the live location marker
                    if (liveMarker) {
                        liveMarker.setLatLng([driverLat, driverLon]); // Update position
                    } else {
                        liveMarker = L.marker([driverLat, driverLon], {icon: liveIcon}).addTo(map)
                            .bindPopup("You're here!").openPopup();
                    }

                    // Zoom the map to the driver's location
                    map.setView([driverLat, driverLon], 14); // Adjust zoom level if necessary
                }, function(error) {
                    alert("Geolocation failed: " + error.message);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        };
    </script>
</body>
</html>
