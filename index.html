<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fueling Stations Map for Drivers</title>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 75vh;
            width: 100%;
            margin-top: 50px; /* Space for the "Get Location" button */
        }
        /* Get Location button */
        #locationBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            z-index: 9999;
            width: 150px;
        }
        /* Custom title above the map */
        #title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 22px;
            color: black;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 15px;
            border-radius: 5px;
            z-index: 9999;
        }
        /* Custom pin styling for fuel stations */
        .leaflet-marker-icon {
            width: 40px;
            height: 40px;
            background-color: green;
            border-radius: 50%;
            color: white;
            text-align: center;
            line-height: 40px;
        }
        /* Custom icon for current location */
        .leaflet-live-location-icon {
            width: 40px;
            height: 40px;
            background-color: #FF6347; /* Tomato color for current location */
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            color: white;
            font-size: 18px;
        }
        /* Styling for the popups */
        .leaflet-popup-content {
            font-size: 14px;
        }
        /* Custom button for opening Google Maps */
        .popup-options {
            margin-top: 10px;
        }
        .popup-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            width: 100%;
        }
        .popup-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="title">Fueling Stations Map for Drivers</div>
    <button id="locationBtn">Get My Location</button>
    <div id="map"></div>

    <script>
        // OpenRouteService API key
        const apiKey = '5b3ce3597851110001cf62481912bd9edc9d45f39c48928910e7ce67';  // Replace with your actual key

        // Sample fuel station data (replace with actual stations)
        const stations = [
            {lat: 43.7449999, lon: -79.6912853, name: "BVD Brampton, 130 Delta Park, Brampton, ON"},
            {lat: 43.6590715, lon: -79.6561726, name: "BVD Mississauga, 6125 Ordan Dr, Mississauga, ON"}
            // Add more stations as needed
        ];

        // Create the map
        var map = L.map('map').setView([43.651070, -79.347015], 10); // Default Toronto location

        // Add OpenStreetMap layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var liveMarker; // Variable for live location marker

        // Function to get the user's location and update the map
        document.getElementById('locationBtn').onclick = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;

                    // Set the map's center to the user's location
                    map.setView([lat, lon], 14);

                    // Add or update live location marker (circle marker with custom color)
                    if (!liveMarker) {
                        liveMarker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'leaflet-live-location-icon',
                                html: 'You are here'
                            })
                        }).addTo(map);
                    } else {
                        liveMarker.setLatLng([lat, lon]);
                    }

                    liveMarker.bindPopup("You're here!");

                    // Call the function to calculate distances to fuel stations
                    calculateDistances(lat, lon);
                });
            }
        };

        // Add markers for each fuel station
        stations.forEach(function(station) {
            var marker = L.marker([station.lat, station.lon]).addTo(map)
                .bindPopup(`
                    <b>${station.name}</b><br>Distance: <span class="distance">Calculating...</span>
                    <div class="popup-options">
                        <button class="popup-button" onclick="copyAddress('${station.name}')">Copy Address</button>
                        <button class="popup-button" onclick="openGoogleMaps('${station.name}')">Open in Google Maps</button>
                    </div>
                `)
                .on('click', function() {
                    // When a station is clicked, calculate the distance from the user's location
                    if (liveMarker) {
                        const userLat = liveMarker.getLatLng().lat;
                        const userLon = liveMarker.getLatLng().lng;
                        calculateDistance(userLat, userLon, station.lat, station.lon, this);
                    }
                });
        });

        // Function to calculate the distance between two coordinates using the Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2, stationPopup = null) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            return distance;
        }

        // Function to calculate distances from the user's location to all fuel stations
        function calculateDistances(userLat, userLon) {
            stations.forEach(function(station, index) {
                var distance = getDistance(userLat, userLon, station.lat, station.lon);
                var marker = L.marker([station.lat, station.lon]).addTo(map)
                    .bindPopup(`<b>${station.name}</b><br>Distance: ${distance.toFixed(2)} km`)
                    .openPopup();
            });
        }

        // Haversine formula to calculate distance between two coordinates
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            return distance;
        }

        // Function to copy the address to clipboard
        function copyAddress(address) {
            var textArea = document.createElement("textarea");
            textArea.value = address;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("Address copied to clipboard!");
        }

        // Function to open the address in Google Maps
        function openGoogleMaps(address) {
            var mapsUrl = `https://www.google.com/maps?q=${encodeURIComponent(address)}`;
            window.open(mapsUrl, '_blank');
        }

        // Automatically fetch and update location on page load
        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;

                    // Update live marker location on map
                    if (!liveMarker) {
                        liveMarker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'leaflet-live-location-icon',
                                html: 'You are here'
                            })
                        }).addTo(map);
                    } else {
